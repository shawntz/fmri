#!/bin/bash
# @Author: Shawn Schwartz - Stanford Memory Lab
# @Date: December 18, 2025
# @Description: Display diagnostic reports for a specific subject
# @Usage: ./show_diagnostics_for <subject_id>
# @Example: ./show_diagnostics_for 1302

# Check if subject ID was provided
if [ $# -eq 0 ]; then
    echo "Error: Subject ID required"
    echo "Usage: $0 <subject_id>"
    echo "Example: $0 1302"
    exit 1
fi

SUBJECT_ID=$1

# Search for diagnostics directory in common locations
DIAGNOSTICS_DIR=""

# Check relative path from repo root
if [ -d "logs/diagnostics" ]; then
    DIAGNOSTICS_DIR="logs/diagnostics"
# Check parent directory
elif [ -d "../logs/diagnostics" ]; then
    DIAGNOSTICS_DIR="../logs/diagnostics"
# Check if we're in the logs directory already
elif [ -d "diagnostics" ]; then
    DIAGNOSTICS_DIR="diagnostics"
else
    echo "Error: Diagnostics directory not found"
    echo "Searched in:"
    echo "  - logs/diagnostics"
    echo "  - ../logs/diagnostics"
    echo "  - diagnostics"
    exit 1
fi

echo "Searching for subject ${SUBJECT_ID} diagnostics..."
echo ""

# Find directories matching the subject ID pattern (YYYYMMDD_HHMMSS_SUBJECTID)
SUBJECT_DIRS=$(find "${DIAGNOSTICS_DIR}" -type d -name "*_${SUBJECT_ID}" 2>/dev/null)

if [ -z "${SUBJECT_DIRS}" ]; then
    echo "No diagnostic directories found for subject ${SUBJECT_ID}"
    echo ""
    echo "Recent diagnostic runs:"
    ls -1dt "${DIAGNOSTICS_DIR}"/*/ 2>/dev/null | head -10
    exit 0
fi

# For each matching directory, find and display all files
echo "${SUBJECT_DIRS}" | while IFS= read -r dir; do
    echo "========================================="
    echo "Diagnostic run: $(basename ${dir})"
    echo "========================================="
    echo ""

    # Find all files in this directory
    find "${dir}" -type f -exec echo "-----------------------------------------" \; -exec echo "File: {}" \; -exec echo "-----------------------------------------" \; -exec head -n 20 {} \; -exec echo "" \;
done
