#!/bin/bash
# @Author: Shawn Schwartz - Stanford Memory Lab
# @Date: December 18, 2025
# @Description: Display diagnostic reports for a specific subject
# @Usage: ./show_diagnostics_for <subject_id>
# @Example: ./show_diagnostics_for 1302

# Check if subject ID was provided
if [ $# -eq 0 ]; then
    echo "Error: Subject ID required"
    echo "Usage: $0 <subject_id>"
    echo "Example: $0 1302"
    exit 1
fi

SUBJECT_ID=$1

# Search for diagnostics directory in common locations
DIAGNOSTICS_DIR=""

# Check relative path from repo root
if [ -d "logs/diagnostics" ]; then
    DIAGNOSTICS_DIR="logs/diagnostics"
# Check parent directory
elif [ -d "../logs/diagnostics" ]; then
    DIAGNOSTICS_DIR="../logs/diagnostics"
# Check if we're in the logs directory already
elif [ -d "diagnostics" ]; then
    DIAGNOSTICS_DIR="diagnostics"
else
    echo "Error: Diagnostics directory not found"
    echo "Searched in:"
    echo "  - logs/diagnostics"
    echo "  - ../logs/diagnostics"
    echo "  - diagnostics"
    exit 1
fi

echo "Searching for subject ${SUBJECT_ID} in ${DIAGNOSTICS_DIR}..."
echo ""

# Find all diagnostic files matching the subject ID
FOUND_FILES=$(find "${DIAGNOSTICS_DIR}" -type f -name "*${SUBJECT_ID}*" 2>/dev/null)

if [ -z "${FOUND_FILES}" ]; then
    echo "No diagnostic files found for subject ${SUBJECT_ID}"
    echo ""
    echo "Recent diagnostic runs:"
    ls -1dt "${DIAGNOSTICS_DIR}"/*/ 2>/dev/null | head -5
    exit 0
fi

# Display each file
echo "${FOUND_FILES}" | while IFS= read -r file; do
    echo "========================================="
    echo "File: ${file}"
    echo "========================================="
    head -n 20 "${file}"
    echo ""
done
